<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import type { CommentSectionStat, ReplyItem } from '@/models/communication/comment_model.ts'
import utils from '@/utils/mixin.ts'

const reply_item = defineModel<ReplyItem>('reply_item', { required: true })
const comment_section_stat = defineModel<CommentSectionStat>('comment_section_stat', {
  required: true
})
defineExpose({ comment_section_stat })

const is_root = computed(() => {
  return !reply_item.value.root
})
const comment_content = computed(() => {
  return reply_item.value.content ?? ''
})
const handleLike = () => {
  const { oid_str, rpid_str } = reply_item.value
  console.log(`待实现点赞功能`, oid_str, rpid_str)
}
const handleHate = () => {
  const { oid_str, rpid_str } = reply_item.value
  console.log(`待实现点赞功能`, oid_str, rpid_str)
}
const handleCommentReply = () => {
  console.log('待实现回复功能')
  comment_section_stat.value.rpidTarget === reply_item.value.rpid_str ||
  !comment_section_stat.value.is_reply_section_active
    ? (comment_section_stat.value.is_reply_section_active =
        !comment_section_stat.value.is_reply_section_active)
    : undefined
  comment_section_stat.value.replyTarget = reply_item.value.member.uname
  comment_section_stat.value.oid = reply_item.value.oid_str
  comment_section_stat.value.root = reply_item.value.root_str
  comment_section_stat.value.parent = reply_item.value.parent_str
  comment_section_stat.value.rpidTarget = reply_item.value.rpid_str
  comment_section_stat.value.reply_content = ''
}
</script>

<template>
  <div class="comment-item">
    <el-avatar class="user-avater" :size="is_root ? 'large' : 'small'">
      <img
        :src="reply_item.member.avatar? reply_item.member.avatar : 'https://static.hdslb.com/images/member/noface.gif'"
        referrerpolicy="no-referrer"
        alt="头像加载失败"
      />
    </el-avatar>
    <div class="comment-main">
      <el-card shadow="never" body-style="border:none;padding:0px;">
        <template #header class="header">
          <div class="user-info">
            <div class="user-name">
              {{ reply_item.member.uname }}
            </div>
            <div class="user-level">
              <img
                width="30"
                height="30"
                :src="`https://i0.hdslb.com/bfs/seed/jinkela/short/webui/user-profile/img/level_${reply_item?.member.level_info.current_level ?? 0}.svg`"
                alt="加载失败"
                referrerpolicy="no-referrer"
              />
            </div>
          </div>
        </template>
        <template #default>
          <div class="comment-content">
            <mavon-editor
              :model-value="comment_content"
              :subfield="false"
              defaultOpen="preview"
              :toolbarsFlag="false"
              :editable="false"
              :scrollStyle="true"
              editor-background="transparent"
              previewBackground="transparent"
              :box-shadow="false"
              style="min-height: 2rem; line-height: 2rem; min-width: 2rem; font-size: 1.25rem"
            >
            </mavon-editor>
          </div>
        </template>
        <template #footer style="border-top: none; padding: 0">
          <div class="comment-footer">
            <div class="pubdate">
              {{ utils.formatDateTS(reply_item.ctime) }}
            </div>
            <div class="like">
              <button class="like-btn" @click="handleLike">
                <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M9.283433333333333 2.0303066666666663C9.095466666666667 2.0083933333333333 8.921333333333333 2.09014 8.828166666666666 2.1991199999999997C8.424633333333333 2.6711333333333336 8.332133333333333 3.3649466666666665 8.029333333333334 3.9012466666666663C7.630633333333333 4.607453333333333 7.258833333333333 5.034486666666666 6.800866666666666 5.436006666666666C6.42382 5.7665733333333336 6.042199999999999 5.987959999999999 5.666666666666666 6.09112L5.666666666666666 13.1497C6.19062 13.1611 6.751966666666666 13.168333333333333 7.333333333333333 13.168333333333333C8.831233333333333 13.168333333333333 10.1019 13.120766666666665 10.958166666666665 13.076699999999999C11.565133333333332 13.045433333333332 12.091966666666666 12.7451 12.366466666666668 12.256733333333333C12.7516 11.571599999999998 13.2264 10.5669 13.514166666666664 9.3835C13.7823 8.2808 13.904599999999999 7.374333333333333 13.959466666666666 6.734999999999999C13.984933333333332 6.438646666666667 13.750433333333334 6.166686666666667 13.386666666666665 6.166686666666667L10.065133333333332 6.166686666666667C9.898433333333333 6.166686666666667 9.742666666666667 6.08362 9.649833333333333 5.945166666666666C9.536066666666667 5.775493333333333 9.560033333333333 5.5828533333333334 9.6312 5.403346666666666C9.783966666666666 5.013846666666666 9.983933333333333 4.432846666666666 10.062766666666667 3.90454C10.1406 3.3830066666666667 10.121599999999999 2.9639466666666667 9.917133333333332 2.57626C9.697399999999998 2.1596933333333332 9.448266666666665 2.0495266666666665 9.283433333333333 2.0303066666666663zM10.773433333333333 5.166686666666666L13.386666666666665 5.166686666666666C14.269133333333333 5.166686666666666 15.036999999999999 5.875273333333333 14.9558 6.8206C14.897 7.505533333333333 14.767199999999999 8.462733333333333 14.485833333333334 9.6198C14.170333333333334 10.917200000000001 13.6532 12.008466666666665 13.238166666666666 12.746766666666666C12.7729 13.574433333333333 11.910266666666667 14.029 11.009566666666666 14.075366666666667C10.14 14.120166666666666 8.851766666666666 14.168333333333333 7.333333333333333 14.168333333333333C5.862206666666666 14.168333333333333 4.51776 14.1231 3.565173333333333 14.079633333333334C2.4932333333333334 14.030733333333332 1.5939999999999999 13.234466666666666 1.4786599999999999 12.143466666666665C1.4028 11.426066666666665 1.3333333333333333 10.4978 1.3333333333333333 9.501666666666665C1.3333333333333333 8.588966666666666 1.3916466666666667 7.761233333333333 1.4598999999999998 7.104466666666667C1.5791666666666666 5.95696 2.5641 5.166686666666666 3.671693333333333 5.166686666666666L5.166666666666666 5.166686666666666C5.3793066666666665 5.166686666666666 5.709213333333333 5.063186666666667 6.141613333333333 4.68408C6.516733333333333 4.355193333333333 6.816366666666667 4.015666666666666 7.158533333333333 3.409613333333333C7.5023 2.8007333333333335 7.6041 2.0920066666666663 8.068066666666667 1.54932C8.372133333333332 1.1936466666666665 8.8718 0.9755333333333334 9.399233333333333 1.03704C9.949866666666665 1.10124 10.457733333333334 1.4577866666666666 10.801633333333331 2.109713333333333C11.148866666666665 2.767993333333333 11.143799999999999 3.4356599999999995 11.051833333333335 4.0520933333333335C10.993899999999998 4.44022 10.875366666666666 4.852359999999999 10.773433333333333 5.166686666666666zM4.666666666666666 13.122166666666667L4.666666666666666 6.166686666666667L3.671693333333333 6.166686666666667C3.029613333333333 6.166686666666667 2.5161533333333335 6.615046666666666 2.4545466666666664 7.207833333333333C2.3890599999999997 7.837933333333333 2.333333333333333 8.630433333333333 2.333333333333333 9.501666666666665C2.333333333333333 10.453433333333333 2.399833333333333 11.345266666666667 2.473113333333333 12.038333333333334C2.533993333333333 12.614133333333331 3.0083466666666667 13.053199999999999 3.6107466666666665 13.0807C3.9228066666666668 13.094899999999999 4.278173333333333 13.109333333333334 4.666666666666666 13.122166666666667z"
                  />
                </svg>
                <span class="like-num">{{ reply_item.like }}</span>
              </button>
            </div>
            <div class="dislike">
              <button class="dislike-btn" @click="handleHate">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                  <path
                    d="M9.283433333333333 13.9697C9.095466666666667 13.9916 8.921333333333333 13.909866666666666 8.828166666666666 13.8009C8.424633333333333 13.328866666666666 8.332133333333333 12.635066666666667 8.029333333333334 12.098766666666666C7.630633333333333 11.392566666666667 7.258833333333333 10.9655 6.800866666666666 10.564C6.42382 10.233433333333332 6.042199999999999 10.012033333333333 5.666666666666666 9.908866666666666L5.666666666666666 2.8503266666666662C6.19062 2.83892 6.751966666666666 2.8316799999999995 7.333333333333333 2.8316799999999995C8.831233333333333 2.8316799999999995 10.1019 2.87922 10.958166666666665 2.923313333333333C11.565133333333332 2.9545733333333333 12.091966666666666 3.254906666666667 12.366466666666668 3.74326C12.7516 4.428373333333333 13.2264 5.4331 13.514166666666664 6.616486666666667C13.7823 7.719199999999999 13.904599999999999 8.625666666666666 13.959466666666666 9.265C13.984933333333332 9.561366666666666 13.750433333333334 9.833333333333332 13.386666666666665 9.833333333333332L10.065133333333332 9.833333333333332C9.898433333333333 9.833333333333332 9.742666666666667 9.9164 9.649833333333333 10.054833333333333C9.536066666666667 10.224499999999999 9.560033333333333 10.417133333333332 9.6312 10.596633333333333C9.783966666666666 10.986166666666666 9.983933333333333 11.567166666666667 10.062766666666667 12.095466666666667C10.1406 12.616966666666666 10.121599999999999 13.036066666666665 9.917133333333332 13.423766666666666C9.697399999999998 13.8403 9.448266666666665 13.950466666666665 9.283433333333333 13.9697zM10.773433333333333 10.833333333333332L13.386666666666665 10.833333333333332C14.269133333333333 10.833333333333332 15.036999999999999 10.124733333333332 14.9558 9.1794C14.897 8.494466666666666 14.767199999999999 7.537266666666666 14.485833333333334 6.380213333333334C14.170333333333334 5.08278 13.6532 3.991546666666667 13.238166666666666 3.25324C12.7729 2.425586666666667 11.910266666666667 1.9710199999999998 11.009566666666666 1.9246400000000001C10.14 1.8798599999999999 8.851766666666666 1.8316866666666665 7.333333333333333 1.8316866666666665C5.862206666666666 1.8316866666666665 4.51776 1.8769066666666667 3.565173333333333 1.9203599999999998C2.4932333333333334 1.969253333333333 1.5939999999999999 2.765553333333333 1.4786599999999999 3.856533333333333C1.4028 4.573953333333333 1.3333333333333333 5.502233333333333 1.3333333333333333 6.498353333333332C1.3333333333333333 7.411033333333333 1.3916466666666667 8.238766666666667 1.4598999999999998 8.895533333333333C1.5791666666666666 10.043033333333334 2.5641 10.833333333333332 3.671693333333333 10.833333333333332L5.166666666666666 10.833333333333332C5.3793066666666665 10.833333333333332 5.709213333333333 10.936833333333333 6.141613333333333 11.3159C6.516733333333333 11.644799999999998 6.816366666666667 11.984333333333334 7.158533333333333 12.590399999999999C7.5023 13.199266666666666 7.6041 13.907999999999998 8.068066666666667 14.4507C8.372133333333332 14.806333333333331 8.8718 15.024466666666665 9.399233333333333 14.962966666666667C9.949866666666665 14.898766666666667 10.457733333333334 14.542233333333332 10.801633333333331 13.8903C11.148866666666665 13.232 11.143799999999999 12.564333333333332 11.051833333333335 11.947933333333333C10.993899999999998 11.5598 10.875366666666666 11.147633333333333 10.773433333333333 10.833333333333332zM4.666666666666666 2.8778466666666667L4.666666666666666 9.833333333333332L3.671693333333333 9.833333333333332C3.029613333333333 9.833333333333332 2.5161533333333335 9.384966666666667 2.4545466666666664 8.792166666666667C2.3890599999999997 8.162066666666666 2.333333333333333 7.369566666666666 2.333333333333333 6.498353333333332C2.333333333333333 5.546566666666667 2.399833333333333 4.654719999999999 2.473113333333333 3.96168C2.533993333333333 3.385866666666667 3.0083466666666667 2.946793333333333 3.6107466666666665 2.91932C3.9228066666666668 2.9050866666666666 4.278173333333333 2.8906666666666667 4.666666666666666 2.8778466666666667z"
                  />
                </svg>
                <span class="dislike-num">{{ reply_item.dislike }}</span>
              </button>
            </div>
            <div class="reply">
              <button class="reply-btn" @click="handleCommentReply">回复</button>
            </div>
          </div>
        </template>
      </el-card>
      <div class="comment-tag" v-if="is_root && reply_item.up_action.like">UP主觉得很赞</div>
    </div>
  </div>
</template>

<style scoped>
.comment-tag {
  width: fit-content;
  color: #757575;
  background-color: #f4f4f4;
  padding: 0.375rem;
  border-radius: 0.125rem;
  box-sizing: border-box;
  font-size: 0.75rem;
  line-height: 1;
}

svg:not(:root) {
  overflow-clip-margin: content-box;
  overflow: hidden;
  width: 1rem;
  height: 1rem;
}

.like-btn,
.dislike-btn,
.reply-btn {
  padding: 0;
  outline: none;
  border: none;
  background: transparent;
  height: 1.5rem;
  font-size: 0.8125rem;
  color: #9499a0;
  display: inline-flex;
  align-items: center;
  cursor: pointer;
}

.comment-footer > :not(:first-child) {
  margin-left: 1.25rem;
}

.comment-content :deep(.v-note-wrapper) {
  border: unset;
}

.comment-content :deep(.v-show-content) {
  padding: 0 !important;
}

.comment-footer {
  width: 100%;
  display: flex;
  align-items: center;
  position: relative;
  margin-top: 0.1875rem;
  font-size: 0.8125rem;
  color: #9499a0;
}

.comment-main :deep(.el-card) {
  border: none;
}

.comment-main :deep(.el-card__footer) {
  border-top: none;
  padding: 0;
}

.comment-main :deep(.el-card__header) {
  border-bottom: none;
  margin-bottom: 0.2rem;
  padding: 0;
}

.user-level {
  margin-left: 0.3125rem;
  width: 1.875rem;
  height: 1.875rem;
}

.user-name {
  color: #61666d;
  font-size: 0.9rem;
  font-weight: 500;
}

.user-info {
  display: inline-flex;
  align-items: center;
}

.comment-item {
  display: flex;
}

.comment-main {
  position: relative;
  padding-left: 0.5rem;
  padding-top: 1rem;
  width: 100%;
  line-height: 1.5;
}

.user-avater {
  position: relative;
  left: 0.5rem;
  top: 0.5rem;
  width: 3.5rem;
  height: 3.5rem;
  transform-origin: left top;
  transform: scale(0.83333333);
  flex-shrink: 0;
}
</style>
